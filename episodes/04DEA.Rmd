---
title: 'Differential expression analysis (DEA)'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- How can we identify the differentially expressed proteins between experimental groups?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Conduct differential expression analysis using *limpa*
- Visualise the top differentially expressed proteins

::::::::::::::::::::::::::::::::::::::::::::::::

## Differential Expression Analysis

Now it is time to analyse our data and investigate proteins that are differentially expressed between our two experimental groups (control vs active Crohnâ€™s disease). We will make use of the *limma* package and closely related *limpa* functions specifically designed for proteomics data. 

First, we will fit a linear model that includes both Class and Batch effects.

```{r}
# Set the control group as our reference
Class <- relevel(Class, ref = "Ctrl")
## We also need to reset our colors to match the correct labels
Class.color <- Class
levels(Class.color) <- hcl.colors(nlevels(Class), palette = "cividis")

# Fit a linear model
design <- model.matrix(~Class + Batch)
design
```

We can see both Class and Batch accounted for in our design matrix. 

Now we run the *limpa* differential expression analysis function `dpcDE()` to identify the top differentially expressed proteins in our dataset.

```{r}
fit <- dpcDE(y.protein, design, plot = TRUE)
fit <- eBayes(fit)
topTable(fit, coef = 2)
```

We can visualise the log2 expression values for differentially expressed proteins, together with standard errors.

```{r}
plotProtein(y.protein, "PRTN3_HUMAN", col = as.character(Class.color))
legend('topleft', legend = levels(Class), fill = levels(Class.color))

plotProtein(y.protein, "S10A9_HUMAN", col = as.character(Class.color))
legend('topleft', legend = levels(Class), fill = levels(Class.color))
```

## Visualise differentially expressed proteins

### Heatmap

We can filter our results to the top up to 50 most significant differentially expressed proteins, then visualise via a clustered heatmap.

```{r}
# Save our DEA results as a dataframe
results <- topTable(fit, coef = 2, number = Inf)

# Limit to the top 50 most significant results
sig_proteins <- results %>%
  filter(adj.P.Val < 0.05) %>% # filter by p value
  top_n(50, wt = abs(logFC)) %>% # filter by absolute log fold change value
  pull(Protein.Names)
expr_matrix <- y.protein$E[sig_proteins, ]

# Scale the data and visualise via heatmap
scaled_expr <- scale(t(scale(t(expr_matrix))))

pheatmap(scaled_expr,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         show_rownames = TRUE,
         show_colnames = FALSE,
         annotation_col = y.protein$targets,
         clustering_method = 'ward.D')
```

### Volcano plot

We can also visualise our results as a volcano plot using `EnhancedVolcano()`.

```{r}
EnhancedVolcano(results,
                lab = results$Protein.Names,
                x = 'logFC',
                y = 'adj.P.Val',
                pCutoff = 0.05,
                FCcutoff = 1.0,
                pointSize = 2.0,
                labSize = 3.0,
                drawConnectors = TRUE,
                maxoverlapsConnectors = Inf,
                lengthConnectors = unit(0.001, 'npc'),
                typeConnectors ='closed')
```


::::::::::::::::::::::::::::::::::::: keypoints 

- We can fit a linear model to our data and conduct differential expression analysis using *limpa* and *limma* functions.
- There are many different ways to visualise differentially expressed proteins.

::::::::::::::::::::::::::::::::::::::::::::::::

